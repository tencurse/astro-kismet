---
import Breadcrumbs from '@/components/Breadcrumbs.astro'
import PageHead from '@/components/PageHead.astro'
import WorkCard from '@/components/WorkCard.astro'
import Layout from '@/layouts/Layout.astro'
import { getAllTags, getWorksByTag } from '@/lib/data-utils'

export async function getStaticPaths() {
  const tagMap = await getAllTags()
  const uniqueTags = Array.from(tagMap.keys())

  return Promise.all(
    uniqueTags.map(async (tag) => {
      const works = await getWorksByTag(tag)
      return {
        params: { id: tag },
        props: {
          tag,
          works,
        },
      }
    }),
  )
}

const { tag, works } = Astro.props
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title={`Works in ${tag}`}
    description={`A collection of works in tags ${tag}.`}
    noindex
  />
  <Breadcrumbs
    items={[
      { href: '/tags', label: 'Tags', icon: 'lucide:tags' },
      { label: tag, icon: 'lucide:tag' },
    ]}
  />

  {
    works.length > 0 && (
      <section class:list={[works.length > 0 && 'mt-8']}>
        <h2 class="mb-4 text-3xl font-semibold">
          {works.length} work{works.length === 1 ? '' : 's'} in {tag}
        </h2>
        <ul class="flex flex-col gap-y-6">
          {works.map((work, index) => (
            <li>
              <WorkCard work={work} />
              {index < works.length - 1 && (
                <div class="mb-8 flex items-center justify-center gap-4">
                  <div class="bg-muted-foreground/25 dark:bg-muted h-px w-16" />
                  <div class="bg-muted-foreground/25 dark:bg-muted h-1 w-1 rotate-45" />
                  <div class="bg-muted-foreground/25 dark:bg-muted h-px w-16" />
                </div>
              )}
            </li>
          ))}
        </ul>
      </section>
    )
  }
</Layout>
